"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[59002],{3905:function(e,t,n){n.d(t,{Zo:function(){return c},kt:function(){return m}});var a=n(67294);function l(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){l(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,l=function(e,t){if(null==e)return{};var n,a,l={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(l[n]=e[n]);return l}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(l[n]=e[n])}return l}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,l=e.mdxType,r=e.originalType,s=e.parentName,c=o(e,["components","mdxType","originalType","parentName"]),d=p(n),m=l,h=d["".concat(s,".").concat(m)]||d[m]||u[m]||r;return n?a.createElement(h,i(i({ref:t},c),{},{components:n})):a.createElement(h,i({ref:t},c))}));function m(e,t){var n=arguments,l=t&&t.mdxType;if("string"==typeof e||l){var r=n.length,i=new Array(r);i[0]=d;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o.mdxType="string"==typeof e?e:l,i[1]=o;for(var p=2;p<r;p++)i[p]=n[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},15037:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return i},contentTitle:function(){return o},metadata:function(){return s},assets:function(){return p},toc:function(){return c},default:function(){return d}});var a=n(87462),l=n(63366),r=(n(67294),n(3905)),i={title:"How to build Apache APISIX in ARM Ubuntu",authors:[{name:"Qi Guo",title:"Author",url:"https://github.com/guoqqqi",image_url:"https://avatars.githubusercontent.com/u/72343596?v=4"}],keywords:["Apache APISIX","arm","ubuntu","Apple Macbook Pro M1"],description:"By reading this article, you will learn how to build Apache APISIX (M1 chip environment) in ARM Ubuntu from source code.",tags:["Technology"]},o=void 0,s={permalink:"/blog/2022/01/11/building-apisix-in-ubuntu-for-arm",source:"@site/blog/2022/01/11/building-apisix-in-ubuntu-for-arm.md",title:"How to build Apache APISIX in ARM Ubuntu",description:"By reading this article, you will learn how to build Apache APISIX (M1 chip environment) in ARM Ubuntu from source code.",date:"2022-01-11T00:00:00.000Z",formattedDate:"January 11, 2022",tags:[{label:"Technology",permalink:"/blog/tags/technology"}],readingTime:4.555,truncated:!0,authors:[{name:"Qi Guo",title:"Author",url:"https://github.com/guoqqqi",image_url:"https://avatars.githubusercontent.com/u/72343596?v=4",imageURL:"https://avatars.githubusercontent.com/u/72343596?v=4"}],prevItem:{title:"Webinar | From API to Database: A Comprehensive Solution to Perform Online Load Test on Your Distributed System",permalink:"/blog/2022/01/11/apisix-with-shardingsphere-meetup"},nextItem:{title:"Biweekly Report\uff5c12.16-12.31 Feature Highlights Update in Progress",permalink:"/blog/2022/01/05/weekly-report-1231"}},p={authorsImageUrls:[void 0]},c=[{value:"Clone source code",id:"clone-source-code",children:[]},{value:"Installing Dependencies",id:"installing-dependencies",children:[]},{value:"Install etcd",id:"install-etcd",children:[{value:"Installing etcd Error Guide",id:"installing-etcd-error-guide",children:[]},{value:"Running the etcd service in Docker",id:"running-the-etcd-service-in-docker",children:[]}]},{value:"Starting Apache APISIX",id:"starting-apache-apisix",children:[]},{value:"Summary",id:"summary",children:[]}],u={toc:c};function d(e){var t=e.components,n=(0,l.Z)(e,["components"]);return(0,r.kt)("wrapper",(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"By reading this article you will learn how to build Apache APISIX (M1 chip environment) in ARM Ubuntu from source code. The ARM Ubuntu system is installed with the help of ",(0,r.kt)("a",{parentName:"p",href:"https://multipass.run/"},"https://multipass.run/"),".")),(0,r.kt)("h2",{id:"clone-source-code"},"Clone source code"),(0,r.kt)("p",null,"First follow the ",(0,r.kt)("a",{parentName:"p",href:"https://apisix.apache.org/docs/apisix/how-to-build/"},"official documentation"),". Clone the Apache APISIX source code repository and go to the project directory."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"git clone https://github.com/apache/apisix.git\ncd apisix\ngit checkout release/2.11\n")),(0,r.kt)("h2",{id:"installing-dependencies"},"Installing Dependencies"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Install the dependencies required for the project in one click via an automation script, running the following command in the ",(0,r.kt)("strong",{parentName:"li"},"project root")," directory.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"bash utils/install-dependencies.sh\n")),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1641911830267-75310d03-1039-4f5a-a8b1-94c01474a086.png",alt:"1.png"})),(0,r.kt)("p",null,"The error message indicates that this is due to a failure to successfully install ",(0,r.kt)("inlineCode",{parentName:"p"},"OpenResty"),". The root cause is that there are no sources for the ",(0,r.kt)("inlineCode",{parentName:"p"},"ARM 64")," platform by default."),(0,r.kt)("ol",{start:2},(0,r.kt)("li",{parentName:"ol"},"Here we install ",(0,r.kt)("inlineCode",{parentName:"li"},"OpenResty")," manually, the installation steps can be found at ",(0,r.kt)("a",{parentName:"li",href:"https://openresty.org/cn/linux-packages.html#ubuntu"},"https://openresty.org/cn/linux-packages.html#ubuntu"),".")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Step 1: Install the several dependencies required to import the GPG public key (they can be removed at any time after the entire installation process is complete).")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"sudo apt-get -y install --no-install-recommends wget gnupg ca-certificates\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Step 2: Import our GPG key.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"wget -O - https://openresty.org/package/pubkey.gpg | sudo apt-key add -\n")),(0,r.kt)("p",null,"The import was successful as shown in the figure below."),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1641911867662-8d1dcb8d-7c1e-4ddd-ad60-2d7448b6c544.png",alt:"2.png"})),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Step 3: Add the official OpenResty APT repository. For x86_64 or amd64 systems, the following command can be used.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'echo "deb http://openresty.org/package/ubuntu $(lsb_release -sc) main" \\\n    | sudo tee /etc/apt/sources.list.d/openresty.list\n')),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"And for ARM64 or aarch64 systems, the following command can be used: (I am running this command on M1, the previous one reports an error)")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'echo "deb http://openresty.org/package/arm64/ubuntu $(lsb_release -sc) main" \\\n    | sudo tee /etc/apt/sources.list.d/openresty.list\n')),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Step 4: Update the APT Index.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"sudo apt-get update\n")),(0,r.kt)("p",null,"The package can then be installed like this, e.g. ",(0,r.kt)("inlineCode",{parentName:"p"},"OpenResty"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"sudo apt-get -y install openresty\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Step 5: (Optional) The package and the corresponding associated package can be deleted by the following command.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"sudo apt-get -y install --no-install-recommends software-properties-common\n")),(0,r.kt)("p",null,"Successful installation of ",(0,r.kt)("inlineCode",{parentName:"p"},"OpenResty"),"."),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1641911892167-2a6b56a9-aad8-400b-99d9-8401718c6ba9.png",alt:"3.png"})),(0,r.kt)("ol",{start:3},(0,r.kt)("li",{parentName:"ol"},"Rerun the installation dependency script (refer to step 1)"),(0,r.kt)("li",{parentName:"ol"},"Next, run the command ",(0,r.kt)("inlineCode",{parentName:"li"},"LUAROCKS_SERVER=https://luarocks.cn")," to install the dependencies.")),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1641911909131-3f30b00e-2939-480e-809d-ccd17e5f15c4.png",alt:"4.png"})),(0,r.kt)("p",null,"Simply run the following command."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"curl https://raw.githubusercontent.com/apache/apisix/master/utils/linux-install-luarocks.sh -sL | bash -\n")),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1641911924788-7e0d2f90-90d6-41cc-8c98-450cdf55a3c1.png",alt:"5.png"})),(0,r.kt)("p",null,"Another error message appears and we run the following command."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"sudo apt install wget sudo unzip\n")),(0,r.kt)("p",null,"We then re-run."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"curl https://raw.githubusercontent.com/apache/apisix/master/utils/linux-install-luarocks.sh -sL | bash -\n")),(0,r.kt)("p",null,"We then proceeded to run the command to install the dependencies: ",(0,r.kt)("inlineCode",{parentName:"p"},"LUAROCKS_SERVER=https://luarocks.cn make deps"),"\nFinally it worked, there were indeed too many problems."),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1641911942296-0ed90547-80b3-4e80-be5a-89cf60ba67b4.png",alt:"6.png"})),(0,r.kt)("p",null,"Most of the dependencies have been successfully installed, but there is a new error message.\nHere it looks like the two repositories have not been successfully cloned, but that's fine, try running them backwards first."),(0,r.kt)("ol",{start:5},(0,r.kt)("li",{parentName:"ol"},"Installing APISIX commands")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"make install\n# If you get an insufficient permissions message, use `sudo make install`\n")),(0,r.kt)("p",null,"Success:"),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1641911956728-0a64adb1-0bc5-489c-bf5b-929177325ab4.png",alt:"7.png"})),(0,r.kt)("h2",{id:"install-etcd"},"Install etcd"),(0,r.kt)("h3",{id:"installing-etcd-error-guide"},"Installing etcd Error Guide"),(0,r.kt)("p",null,"Before starting APISIX you need to install etcd, refer to the ",(0,r.kt)("a",{parentName:"p",href:"https://apisix.apache.org/docs/apisix/2.10/install-dependencies/#ubuntu-1604--1804"},"official documentation"),"."),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"As the tutorial is not written for arm, etcd was installed successfully, but it did not run because the x86 binary was used to start it by default, so it did not run. (You can skip this section and go directly to the section on running the etcd service in Docker)")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Download etcd.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"wget https://github.com/etcd-io/etcd/releases/download/v3.4.13/etcd-v3.4.13-linux-amd64.tar.gz\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Decompress the etcd.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"tar -xvf etcd-v3.4.13-linux-amd64.tar.gz && cd etcd-v3.4.13-linux-amd64 && sudo cp -a etcd etcdctl /usr/bin/\n")),(0,r.kt)("p",null,"Success:"),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1641911973528-258ae3a2-f7c1-41b7-8b4a-9547e7a50035.png",alt:"8.png"})),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Start the etcd service")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"nohup etcd &\n")),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1641911987650-859af5f5-a3f5-4ccc-b27b-30bf2741d65a.png",alt:"9.png"})),(0,r.kt)("p",null,"Then when I ran Apache APISIX later I found that etcd was reporting an error."),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1641912001558-0afe245e-0cc0-405c-8624-0a55b0b63535.png",alt:"10.png"})),(0,r.kt)("p",null,"In the end, I found that running etcd naked on ARM Ubuntu was too problematic, with all sorts of errors, so I decided to run docker instead~."),(0,r.kt)("h3",{id:"running-the-etcd-service-in-docker"},"Running the etcd service in Docker"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Installing Docker")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"sudo apt install docker.io\n")),(0,r.kt)("p",null,"Tip: Common docker commands: (add sudo before the command if you get no permission error)"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"View a list of all containers ",(0,r.kt)("inlineCode",{parentName:"li"},"docker ps -a")),(0,r.kt)("li",{parentName:"ul"},"View the list of running containers ",(0,r.kt)("inlineCode",{parentName:"li"},"docker ps")),(0,r.kt)("li",{parentName:"ul"},"View the list of images ",(0,r.kt)("inlineCode",{parentName:"li"},"docker image list")),(0,r.kt)("li",{parentName:"ul"},"Delete all containers ",(0,r.kt)("inlineCode",{parentName:"li"},"docker container prune")),(0,r.kt)("li",{parentName:"ul"},"Delete all images ",(0,r.kt)("inlineCode",{parentName:"li"},"docker image prune -f -a"))),(0,r.kt)("p",null,"More references: ",(0,r.kt)("a",{parentName:"p",href:"https://www.ruanyifeng.com/blog/2018/02/docker-tutorial.html"},"Docker Getting Started Tutorial - Ruan Yifeng's Weblog"),"."),(0,r.kt)("ol",{start:2},(0,r.kt)("li",{parentName:"ol"},"Pull and run etcd")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"sudo docker run -d --name etcd -p 2379:2379 -e ETCD_UNSUPPORTED_ARCH=arm64 -e ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379 -e ETCD_ADVERTISE_CLIENT_URLS=http://0.0.0.0:2379 gcr.io/etcd-development/etcd:v3.5.1-arm64\n")),(0,r.kt)("p",null,"Note: This image requires a proxy to be turned on.\nSuccess:"),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1641912022850-0ad47270-79e2-4227-a786-9d478906b8b0.png",alt:"11.png"})),(0,r.kt)("p",null,"Verify that etcd has started successfully."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"sudo docker ps -a\n")),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1641912040567-141b520e-4c33-448d-ba33-86e01a9f6114.png",alt:"12.png"})),(0,r.kt)("p",null,"As you can see, etcd has been successfully started."),(0,r.kt)("h2",{id:"starting-apache-apisix"},"Starting Apache APISIX"),(0,r.kt)("p",null,"All dependencies have been prepared and we can now start Apache APISIX ~ refer directly to How to build APISIX ",(0,r.kt)("a",{parentName:"p",href:"https://apisix.apache.org/docs/apisix/how-to-build"},"official documentation"),"."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Installing dependencies")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"make deps\nmake install\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Initialise dependencies and start APISIX")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"apisix init\n\n# start APISIX\napisix start\n\n# stop APISIX\napisix stop\n")),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1641912056163-67b0f11b-a122-4f5b-b7a6-c09662443cce.png",alt:"13.png"})),(0,r.kt)("p",null,"No more error messages, perfect finish!"),(0,r.kt)("h2",{id:"summary"},"Summary"),(0,r.kt)("p",null,"In general, there are two problems: the installation of APISIX dependencies and the etcd part of arm. The etcd part can be solved directly with docker, but there are also some pitfalls when pulling images, which I won't show here."),(0,r.kt)("p",null,"If you have better suggestions, you are welcome to contribute to the Apache APISIX ",(0,r.kt)("a",{parentName:"p",href:"https://apisix.apache.org/docs/apisix/how-to-build/"},"build documentation")," and leave your suggestions to help more people."))}d.isMDXComponent=!0}}]);